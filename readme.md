## Authentication and Security in NodeJS

### Intro & Getting Set Up :

    $ npm init -y
    $ npm install express body-parser ejs

Create the app.js based on boilerplate with the routes for home , login, register

### L1 Security - Username and Password :

    $ npm install mongoose

Update the app.js with require mongoose and mongoose.connect

    $ const mongoose = require('mongoose');
    $ mongoose.connect('mongodb://localhost:27017/test', {useNewUrlParser: true});
    $ userSchema and model

      " const userSchema = new mongoose.Schema({
            username: String,
            password: String
        });
        const User = mongoose.model("User", userSchema); "

Build the post route for register

      " const newUser = new User({
          username: req.body.username,
          password: req.body.password
        }); "

Build the post route for login

      " User.findOne({email:email},function(err,foundUser){})"

**Issue :** Anyone with access to DB will have access to passwords.

### L2 Security - Database Encryption :

-   [Mongoose-Encryption](https://www.npmjs.com/package/mongoose-encryption)


    $ npm i mongoose-encryption

For convenience, you can also pass in a single secret string instead of two keys

-   [Mongoose-Encryption Secret-String](https://www.npmjs.com/package/mongoose-encryption#secret-string-instead-of-two-keys)

How to include or exclude related fields :

    $ userSchema.plugin(encrypt, { secret: secret , encryptedFields: ["password"] });

**Issue :**  Anyone with access to DB and app.js will have access to passwords.

L2 Security Leveraged : Environment Variables

-   [DotEnv Package](https://www.npmjs.com/package/dotenv)


        $ npm i dotenv
        $ require('dotenv').config()
        $ touch .env ( as hidden file)

`const secret = "ThisIsTheSecret"` should be moved to .env as `SECRET=ThisIsTheSecret`

    $ touch .gitignore ( as hidden file)

-   [Gitignore for Node](https://github.com/github/gitignore/blob/master/Node.gitignore)
    ( for instance , node_modules is ignored. All packages might be installed with "npm install" command )

**Issue :** Anyone with access to DB, app.js and .env will have access to passwords.

### L3 Security - Hashing Passwords

-   [Hashing with md](https://www.npmjs.com/package/md5)
    Hashing uses a hash function, which replaced key in encryption and provides a one way - irreversible approach.

        $ npm i md5

**Issue :** might still be hacked by precompiled hash-tables using GPU based computers

-   <https://plaintextoffenders.com/>
-   <https://haveibeenpwned.com/>
    All words from dictionary, all numbers from telephone book = ~ 19.8 B
    TAKES ALMOST 1 SECOND WITH A GPU TO CALCULATE, for MD5 Hashes
-   <https://en.wikipedia.org/wiki/List_of_the_most_common_passwords>

### L4 Security Salting and Hashing ( bcrypty instead of MD )

MD5 : 20B hashes per sec might be generated by using GPUs,
      easy passwords might be resolved in less than 3 seconds
bcrypty : 17K hashes per sec might be generated by using GPUs,
      even easy passwords might take months to be resolved.

-   [Hashing with bcrypt](https://www.npmjs.com/package/bcrypt)

Salt Rounds :

> Every year the number of transistors in a computer chip almost doubles and the cost of that fast computer halves "Moore's Theorem"

Similarly, for every increased number of salt round , the amount of time it takes to hash your password doubles

Check node version by `node --version`
If previous versions required use [Node Version Manager ](https://github.com/nvm-sh/nvm)

    $ npm i bcrypt

### L5 Security Cookies and Sessions

* [passport](https://www.npmjs.com/package/passport)

* [passport-local](https://www.npmjs.com/package/passport-local)

- [passport-local-mongoose](https://www.npmjs.com/package/passport-local-mongoose)

- [express-session](https://www.npmjs.com/package/passport)

> Part1 : Implementing the Modules

>> Step 1 : Install and require the modules, then empty out post and login routes

        $ npm i passport passport-local passport-local-mongoose express-session

queue of the modules is important  :

        const session = require('express-session');
        const passport = require("passport");
        const passportLocalMongoose = require('passport-local-mongoose');

Note : Passport-Local Mongoose does not require passport, passport-local or mongoose dependencies directly but expects you to have these dependencies installed. That's the reason why passport-local is installed but not required.

>> Step 2 : Setup express-session

queue of the syntax is important; express-session should be called by below syntax, before DB session is established and after other app.use functions :

    app.use(session({
      secret: 'keyboard cat',
      resave: false,
      saveUninitialized: true,
      cookie: { secure: true }
    }))

>> Step3 : Setup passport

    app.use(passport.initialize());
    app.use(passport.session());

>> Step 4 : Setup passport-local-mongoose

    userSchema.plugin(passportLocalMongoose);

This will hash and salt the passwords before saving to database; and does a lot of heavy lifting for us!

```
// Enable authentication; in the new approach USE "createStrategy" INSTEAD OF "authenticate"
passport.use(User.createStrategy());

// use static serialize and deserialize of model for passport session support
passport.serializeUser(User.serializeUser());
passport.deserializeUser(User.deserializeUser());
```

Check if collection.ensureIndex is depreciated or not before proceeding ...
* https://github.com/Automattic/mongoose/issues/6890

Note1 : setup session should be before serialize and deserializing them
Note2 : initialize passport should be before passport strategy

> Part2 : Building post routes for register and login

>> Step 1 : Register by passportLocalMongoose

Instead of creating and saving user by direct interaction with DB; use `User.Register`

>> Step 2 : Authenticate by passport

Instead of if statements or compare, use `passport.authenticate` , which will also setup cookies
* [User Authentication with Passport.js](https://mherman.org/blog/user-authentication-with-passport-dot-js/)

We can use `res.redirect` instead of `res.render` for "secret page"; thanks to cookies
>> Step 3 : Generate cookies by express-session

Build the secret route, for the first time by using `req.isAuthenticated()``
express-session creates the content and its ID to save inside cookie, automatically


```
app.get("/secret", function(req, res) {
  if(req.isAuthenticated()){
    res.render("secret");
  }else{
    res.redirect("login");
  }

});

app.post("/register", function(req, res) {
  User.register({username:req.body.username}, req.body.password, function(err, user) {
    if (err) {
      console.log(err);
      res.redirect("/register");
    }else{
      passport.authenticate('local')(req, res, function() {
        res.redirect('/secret');
      });
    }
  });
});

```

>> Step 3 : Build the login route :

alternative1 :
```
app.post("/login", passport.authenticate("local", {
    successRedirect: "/secret",
    failureRedirect: "/login"
}) ,function(req, res){
});
```
alternative2 :
```
app.post("/login", function(req, res) {
  const user = new User({
    email: req.body.username,
    password: req.body.passport
  });

  req.login(user, function(err) {
    if (err) {
      console.log(err);
    }else{
      passport.authenticate('local')(req, res, function() {
        res.redirect('/secret');
      });
    }
  });
});
```

>> Step 4 : Build the logout route :
```
app.get("/logout", function(req, res){
    req.logout();
    res.redirect("/");
});
```

### L6 S OAuth - Open Authorization
Access information on 3rd party web sites , such as other users' emails or contacts etc
OAuth helps log in with Facebook, Twitter, Github etc and provides :

=> Granular Level of access

=> Read/Read+Write Access

=> 3rd party can revoke access

- Step1 : Set Up Your App on 3rd party's developer page
- Step2 : Redirect to Authenticate
- Step3 : User Log In on 3rd party
- Step4 : Grant Permission
- Step5 : Receive Authorization (one time, to authenticate and log in )
- Step6 : Exchange AuthCode for Access Token (temporary, to access pieces of information)

#### Login with Google and OAuth

- [passport-google-oauth20](http://www.passportjs.org/packages/passport-google-oauth20/)

- [Google Developer Console] : (https://console.developers.google.com/)

 - Create Project Secret > Update OAuth consent screen > Receive Credentials

- Save the credentials in .env file

 - CLIENT_ID=69...
 - CLIENT_SECRET=ctB_n...

- Install and require the package :

 - ``` npm install passport-google-oauth20 ```

 - ``` const GoogleStrategy = require('passport-google-oauth20').Strategy; ```


- Update app.js with new strategy :

 - GoogleStrategy

 ```
passport.use(new GoogleStrategy({
    clientID: GOOGLE_CLIENT_ID, ` => process.env.CLIENT_ID `
    clientSecret: GOOGLE_CLIENT_SECRET, `process.env.CLIENT_SECRET `
    callbackURL: "http://www.example.com/auth/google/callback"  => `	http://localhost:3000/auth/google/secrets`

  },
  function(accessToken, refreshToken, profile, cb) {
    User.findOrCreate({ googleId: profile.id }, function (err, user) {
      return cb(err, user);
    });
  }
));
```

 - Warning 1: In case of depreciation warning add ` => userProfileURL: "https://www.googleapis.com/oauth2/v3/userinfo" ` to the GoogleStrategy

 - Warning 2 : Create a new function for by referring to [Stackoverflow-findorcreate](https://stackoverflow.com/questions/20431049/what-is-function-user-findorcreate-doing-and-when-is-it-called-in-passport) and [Mongoose-findOrCreate](https://www.npmjs.com/package/mongoose-findorcreate
). Add the new plugin into user schema :

 ```const findOrCreate = require('mongoose-findorcreate')```

 ```userSchema.plugin(findOrCreate)```

 `npm i mongoose-findorcreate`



- Make necessary updates on register.js and login.js to enable sign up with Google

- Build new route for /auth/google based on [passport-google-oauth20](http://www.passportjs.org/packages/passport-google-oauth20/) and add the secret route :
```
app.get('/auth/google',
  passport.authenticate('google', { scope: ['profile'] }));
```
which will call :
```
app.get('/auth/google/callback',
  passport.authenticate('google', { failureRedirect: '/login' }),
  function(req, res) {
    // Successful authentication, redirect home.
    res.redirect('/callback');
  });
```

- Replace serialize and deserialize of passportLocalMongoose syntax by general syntax; since the first is for only local strategy whereas the second is for all :
```
passport.serializeUser(function(user, done) {
    done(null, user.id);
  });
passport.deserializeUser(function(id, done) {
    User.findById(id, function(err, user) {
      done(err, user);
    });
  });
{
```

- Update the User schema with the google_ID , to enable an association to user_ID. Otherwise, all login requests will generate a new user since the app will consider them as new.

- [Social Buttons for bootstrap](https://lipis.github.io/bootstrap-social/) and update the header.ejs file with the css resource

 - use " btn-social btn-google " on classes for register and login pages
